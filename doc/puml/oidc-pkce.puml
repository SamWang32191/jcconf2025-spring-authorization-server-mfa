@startuml
title OAuth 2.0 / OIDC 授權碼流程（Authorization Code Flow with PKCE）
hide footbox
skinparam SequenceMessageAlign center

actor User as U
participant Client as C
participant "Authorization Server" as AS
participant "Resource Server" as RS

U -> C : 要訪問受保護的Resource
activate C
note right of C
沒發現有效的token
end note
note right of C
產生 code_verifier 與 code_challenge（S256）
end note
C --> AS : GET /oauth2/authorize\n?response_type=code\n&code_challenge=...&code_challenge_method=S256
deactivate C
activate AS
note right of AS
保存 code_challenge 與 method（S256）
end note
AS -> U : 請登入\n(Redirect to login page)
deactivate AS
activate U
U -> AS : \n輸入帳號密碼
deactivate U
activate AS
AS --> C : \n認證與授權成功\n(重導回 Client，附帶 Code)
deactivate AS
activate C
C -> AS : \n用 Code 換取 Token（POST /token）\n含 code_verifier
deactivate C
activate AS
note right of AS
驗證 code_verifier 與先前保存的 code_challenge 是否匹配
（S256 驗證）
end note
AS --> C : \n回傳 ID Token 與 Access Token
deactivate AS
activate C
C -> RS : \n以 Access Token 取得資料 (Authorization: Bearer ...)
deactivate C
activate RS
RS --> C : \n受保護的Resource
deactivate RS
activate C
C --> U : 顯示資料
deactivate C

@enduml